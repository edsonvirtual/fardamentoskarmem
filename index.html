<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karmem Fardamentos | Gest√£o de Excel√™ncia</title>
    
    <!-- Bibliotecas de Estilo e √çcones -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    
    <!-- Bibliotecas de PDF, Gr√°ficos e QR Code -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Playfair+Display:ital,wght@0,700;0,800;0,900;1,700&display=swap');

        :root { 
            --primary: #6a0dad; 
            --secondary: #4f46e5; 
            --danger: #dc3545; 
            --success: #198754; 
            --text-dark: #1e293b;
            --bg-light: #f8fafc;
        }

        body { background-color: var(--bg-light); font-family: 'Inter', sans-serif; color: var(--text-dark); }
        
        .karmem-header { 
            background: linear-gradient(135deg, var(--primary), var(--secondary)); 
            color: white; padding: 1.5rem; margin-bottom: 25px; 
            border-bottom-left-radius: 2rem; border-bottom-right-radius: 2rem;
            box-shadow: 0 10px 25px -5px rgba(106, 13, 173, 0.2);
        }
        
        .nav-pills .nav-link { color: #64748b; font-weight: 600; border-radius: 12px; margin: 0 5px; padding: 0.5rem 1rem; transition: all 0.2s; font-size: 0.9rem; }
        .nav-pills .nav-link.active { background-color: var(--primary) !important; color: white !important; box-shadow: 0 4px 12px rgba(106, 13, 173, 0.15); }

        .glass-card { background: white; border-radius: 24px; border: 1px solid #e2e8f0; padding: 1.25rem; box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.04); }
        
        .card-product { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            cursor: pointer; border-radius: 20px; border: 1px solid #f1f5f9; 
            background: #ffffff; overflow: hidden; position: relative;
        }
        .card-product:hover { transform: translateY(-5px); border-color: var(--primary); box-shadow: 0 20px 25px -5px rgba(106, 13, 173, 0.1); }
        
        .btn-brand { background: var(--primary); color: white; border-radius: 12px; font-weight: 700; transition: all 0.3s; border: none; }
        .btn-brand:hover { background: #5a0b94; transform: translateY(-2px); color: white; box-shadow: 0 8px 20px rgba(106, 13, 173, 0.25); }

        .stat-card { border-radius: 18px; background: #fff; padding: 1.25rem; border: 1px solid #e2e8f0; transition: all 0.2s; position: relative; overflow: hidden; }
        .stat-card::after { content: ""; position: absolute; left: 0; top: 0; width: 4px; height: 100%; background: var(--primary); }
        .stat-label { font-size: 0.7rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; letter-spacing: 1px; margin-bottom: 4px; display: block; }
        .stat-value { font-size: 1.4rem; font-weight: 800; color: var(--text-dark); margin: 0; }

        .cart-item { background: #fdfcff; border: 1px solid #f1f0f7; border-radius: 12px; padding: 10px; margin-bottom: 8px; }

        .measurement-label { font-size: 0.65rem; font-weight: 700; color: #64748b; text-transform: uppercase; }
        .section-title { font-size: 0.85rem; font-weight: 800; color: var(--primary); border-bottom: 1px solid #eee; padding-bottom: 5px; margin-bottom: 15px; }

        /* Estilos de Impress√£o Ultra-Econ√≥micos */
        @media print {
            .no-print, .modal, .modal-backdrop { display: none !important; }
            body { margin: 0 !important; padding: 0 !important; background: white; }
            
            #label-print-area { display: block !important; width: 40mm; height: 60mm; margin: 0; padding: 1mm; }
            
            #thermal-receipt { 
                display: block !important; 
                width: 48mm; 
                margin: 0 !important; 
                padding: 0 !important;
                position: absolute; 
                top: 0;
                left: 0;
                font-family: 'Courier New', Courier, monospace; 
                font-size: 11px; /* Letra ligeiramente maior no cup√£o */
                font-weight: 800; 
                line-height: 1.1; 
                color: #000 !important;
                text-rendering: optimizeLegibility;
            }
            @page { margin: 0; size: auto; }
        }

        #thermal-receipt, #label-print-area { display: none; }
        .receipt-sep { border-bottom: 1px dashed #000; margin: 3px 0; }
        .receipt-row { display: flex; justify-content: space-between; font-weight: 800; }
        
        #label-preview {
            width: 40mm; height: 60mm; padding: 3mm; background: white; border: 1px solid #eee; margin: 0 auto; text-align: center;
            font-family: 'Inter', sans-serif; display: flex; flex-direction: column; justify-content: space-between; align-items: center;
        }

        .scanner-active { border: 2px solid var(--primary) !important; background-color: #f5f0ff !important; animation: pulse-border 2s infinite; }
        @keyframes pulse-border { 0% { box-shadow: 0 0 0 0 rgba(106, 13, 173, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(106, 13, 173, 0); } 100% { box-shadow: 0 0 0 0 rgba(106, 13, 173, 0); } }
    </style>
</head>
<body>

    <header class="karmem-header text-center no-print">
        <div class="container d-flex justify-content-between align-items-center">
            <div style="width: 120px;" class="d-none d-md-block text-start">
                <div class="bg-white rounded-circle d-inline-flex align-items-center justify-content-center" style="width: 40px; height: 40px;">
                    <i class="bi bi-intersect text-primary fs-5"></i>
                </div>
            </div>
            <div>
                <h1 class="h3 fw-bold m-0" style="font-family: 'Playfair Display', serif;">Karmem Fardamentos</h1>
                <p class="small opacity-80 m-0 text-uppercase tracking-widest text-white font-semibold" style="font-size: 0.6rem;">Gest√£o de Atelier de Alta Costura</p>
            </div>
            <div class="text-end" style="width: 120px;">
                <div id="connection-status" class="status-badge bg-danger text-white shadow-sm p-1 rounded-pill px-3" style="font-size: 0.6rem;">OFFLINE</div>
            </div>
        </div>
    </header>

    <div class="container pb-5 no-print">
        <ul class="nav nav-pills mb-4 justify-content-center bg-white p-2 rounded-4 shadow-sm border border-light">
            <li class="nav-item"><a class="nav-link active" data-bs-toggle="pill" href="#tab-vendas"><i class="bi bi-shop me-1"></i>Vendas</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-orcamentos"><i class="bi bi-file-earmark-pdf me-1"></i>Or√ßamentos</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-estoque"><i class="bi bi-box-seam me-1"></i>Estoque</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-clientes"><i class="bi bi-people me-1"></i>Clientes</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="pill" href="#tab-relatorios" onclick="window.initDashboard()"><i class="bi bi-graph-up me-1"></i>Relat√≥rios</a></li>
        </ul>

        <div class="tab-content">
            <!-- ABA VENDAS -->
            <div class="tab-pane fade show active" id="tab-vendas">
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="glass-card h-100">
                            <div class="d-flex justify-content-between align-items-center mb-4">
                                <h6 class="fw-bold text-slate-800 m-0"><i class="bi bi-qr-code-scan me-2"></i>Leitura de Artigos</h6>
                                <div class="input-group shadow-sm rounded-pill overflow-hidden border-0 bg-slate-50 w-50">
                                    <span class="input-group-text bg-transparent border-0 ps-3 text-muted"><i class="bi bi-upc-scan"></i></span>
                                    <input type="text" id="search-pos" class="form-control border-0 bg-transparent py-2 shadow-none small scanner-active" placeholder="Aponte o scanner ou digite..." oninput="window.handleSearchInput(event)" autofocus>
                                </div>
                            </div>
                            <div id="pos-grid" class="row g-3"></div>
                        </div>
                    </div>

                    <div class="col-lg-4">
                        <div class="glass-card sticky-top border-2 border-primary border-opacity-10" style="top: 20px;">
                            <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-2">
                                <h5 class="fw-bold text-primary m-0">Checkout</h5>
                                <button onclick="window.clearCart()" class="btn btn-sm btn-outline-danger border-0 rounded-pill"><i class="bi bi-trash"></i></button>
                            </div>
                            <div class="mb-3"><label class="stat-label">Cliente Respons√°vel</label><select id="client-select-pos" class="form-select border-light shadow-none bg-slate-50 rounded-3"></select></div>
                            <div class="mb-4"><label class="stat-label">Pagamento</label><select id="payment-method-pos" class="form-select border-light shadow-none bg-slate-50 rounded-3"><option value="Dinheiro">üíµ Dinheiro</option><option value="PIX">üì± PIX</option><option value="Cart√£o">üí≥ Cart√£o</option><option value="Transfer√™ncia">üè¶ Transfer√™ncia</option></select></div>
                            <label class="stat-label">Carrinho</label>
                            <div id="cart-items" class="mb-4 small border-bottom pb-3 overflow-auto" style="max-height: 280px; min-height: 100px;"></div>
                            <div class="pt-2">
                                <div class="d-flex justify-content-between h3 fw-bold text-primary mt-2"><span>Total</span><span id="cart-total">R$ 0,00</span></div>
                                <div id="edit-mode-badge" class="alert alert-warning py-1 px-2 small mb-3 d-none rounded-3 mt-3"><i class="bi bi-pencil-square me-1"></i> Editando Or√ßamento</div>
                                <div class="d-grid gap-2 mt-4">
                                    <button class="btn btn-brand py-3 shadow" id="btn-finish" disabled onclick="window.handleTransaction('sale')">FINALIZAR VENDA</button>
                                    <button class="btn btn-outline-secondary py-2 border-2 rounded-3 fw-bold small" id="btn-quote" disabled onclick="window.handleTransaction('quote')">CRIAR OR√áAMENTO</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ABA OR√áAMENTOS -->
            <div class="tab-pane fade" id="tab-orcamentos">
                <div class="glass-card">
                    <h5 class="fw-bold mb-4 text-primary">Gest√£o de Or√ßamentos</h5>
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead><tr><th>Ref</th><th>Data</th><th>Cliente</th><th>Valor</th><th class="text-center">Status</th><th class="text-center">Exportar</th><th class="text-end">A√ß√µes</th></tr></thead>
                            <tbody id="all-quotes-table"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ABA RELAT√ìRIOS -->
            <div class="tab-pane fade" id="tab-relatorios">
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3"><div class="stat-card shadow-sm"><span class="stat-label">Hoje</span><p class="stat-value text-primary" id="stat-today">R$ 0,00</p></div></div>
                    <div class="col-6 col-md-3"><div class="stat-card shadow-sm" style="border-left-color: #198754;"><span class="stat-label">M√™s</span><p class="stat-value text-success" id="stat-month">R$ 0,00</p></div></div>
                    <div class="col-6 col-md-3"><div class="stat-card shadow-sm" style="border-left-color: #ffc107;"><span class="stat-label">Ticket M√©dio</span><p class="stat-value text-warning" id="stat-ticket">R$ 0,00</p></div></div>
                    <div class="col-6 col-md-3"><div class="stat-card shadow-sm" style="border-left-color: #4f46e5;"><span class="stat-label">Pedidos</span><p class="stat-value text-indigo-600" id="stat-count">0</p></div></div>
                </div>
                <div class="row g-4">
                    <div class="col-lg-8">
                        <div class="glass-card mb-4">
                            <input type="month" id="report-month-filter" class="form-control form-control-sm w-auto mb-3" onchange="window.initDashboard()">
                            <canvas id="chart-daily" height="180"></canvas>
                        </div>
                        <div id="daily-details-accordion" class="accordion shadow-sm"></div>
                    </div>
                    <div class="col-lg-4">
                        <div class="glass-card h-100">
                            <select id="report-select-client" class="form-select mb-3" onchange="window.renderClientHistory(this.value)"></select>
                            <div id="report-content" class="p-2 border rounded-4 bg-slate-50 overflow-auto" style="max-height: 600px;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- ESTOQUE -->
            <div class="tab-pane fade" id="tab-estoque">
                <div class="row g-3 mb-4">
                    <div class="col-6 col-md-3"><div class="stat-card shadow-sm"><span class="stat-label">Artigos</span><p class="stat-value text-primary" id="stock-stat-count">0</p></div></div>
                    <div class="col-6 col-md-3"><div class="stat-card shadow-sm" style="border-left-color: #198754;"><span class="stat-label">Stock Total</span><p class="stat-value text-success" id="stock-stat-items">0</p></div></div>
                    <div class="col-6 col-md-3"><div class="stat-card shadow-sm" style="border-left-color: #ffc107;"><span class="stat-label">Valor Total</span><p class="stat-value text-warning" id="stock-stat-value">R$ 0,00</p></div></div>
                    <div class="col-6 col-md-3"><div class="stat-card shadow-sm" style="border-left-color: #dc3545;"><span class="stat-label">Reposi√ß√£o</span><p class="stat-value text-danger" id="stock-stat-low">0</p></div></div>
                </div>
                <div class="glass-card">
                    <form id="form-product" class="row g-3 mb-4 bg-slate-50 p-4 rounded-4 border">
                        <input type="hidden" id="p-id"><div class="col-md-5"><input type="text" id="p-name" class="form-control shadow-sm" placeholder="Nome do Artigo" required></div>
                        <div class="col-md-2"><select id="p-size" class="form-select shadow-sm"><option>P</option><option>M</option><option>G</option><option>GG</option><option>EG</option></select></div>
                        <div class="col-md-2"><input type="number" id="p-price" class="form-control shadow-sm" step="0.01" placeholder="Pre√ßo" required></div>
                        <div class="col-md-2"><input type="number" id="p-stock" class="form-control shadow-sm" placeholder="Quantidade" required></div>
                        <div class="col-md-1"><button type="submit" class="btn btn-brand w-100 py-2 shadow"><i class="bi bi-save"></i></button></div>
                    </form>
                    <table class="table table-hover align-middle"><tbody id="inventory-table"></tbody></table>
                </div>
            </div>

            <!-- CLIENTES (FICHA COMPLETA) -->
            <div class="tab-pane fade" id="tab-clientes">
                <div class="glass-card">
                    <h5 class="fw-bold mb-4 text-primary">Ficha de Cliente & Medidas de Atelier</h5>
                    <form id="form-client" class="bg-slate-50 p-4 rounded-4 border shadow-sm mb-5">
                        <input type="hidden" id="c-id">
                        <div class="section-title"><i class="bi bi-person-vcard me-2"></i>Informa√ß√µes Pessoais</div>
                        <div class="row g-3 mb-4">
                            <div class="col-md-4"><label class="measurement-label">Nome Completo</label><input type="text" id="c-name" class="form-control form-control-sm" required></div>
                            <div class="col-md-3"><label class="measurement-label">WhatsApp</label><input type="text" id="c-phone" class="form-control form-control-sm"></div>
                            <div class="col-md-3"><label class="measurement-label">E-mail</label><input type="email" id="c-email" class="form-control form-control-sm"></div>
                            <div class="col-md-2"><label class="measurement-label">CPF/CNPJ</label><input type="text" id="c-cpf" class="form-control form-control-sm"></div>
                            <div class="col-md-12"><label class="measurement-label">Endere√ßo Completo</label><input type="text" id="c-address" class="form-control form-control-sm"></div>
                        </div>
                        <div class="section-title"><i class="bi bi-rulers me-2"></i>Medidas Corporais (cm)</div>
                        <div class="row g-3 mb-4">
                            <div class="col-6 col-md-2"><label class="measurement-label">Busto</label><input type="number" id="m-bust" class="form-control form-control-sm"></div>
                            <div class="col-6 col-md-2"><label class="measurement-label">Cintura</label><input type="number" id="m-waist" class="form-control form-control-sm"></div>
                            <div class="col-6 col-md-2"><label class="measurement-label">Quadril</label><input type="number" id="m-hips" class="form-control form-control-sm"></div>
                            <div class="col-6 col-md-2"><label class="measurement-label">Ombro</label><input type="number" id="m-shoulder" class="form-control form-control-sm"></div>
                            <div class="col-6 col-md-2"><label class="measurement-label">Manga</label><input type="number" id="m-sleeve" class="form-control form-control-sm"></div>
                            <div class="col-6 col-md-2"><label class="measurement-label">C. Superior</label><input type="number" id="m-length-up" class="form-control form-control-sm"></div>
                            <div class="col-6 col-md-2"><label class="measurement-label">C. Inferior</label><input type="number" id="m-length-down" class="form-control form-control-sm"></div>
                        </div>
                        <div class="d-flex justify-content-end mt-3"><button type="submit" class="btn btn-brand px-5 shadow rounded-3">GUARDAR FICHA T√âCNICA</button></div>
                    </form>
                    <table class="table table-hover border rounded shadow-sm"><tbody id="clients-table"></tbody></table>
                </div>
            </div>
        </div>
    </div>

    <!-- MODAL QR CODE -->
    <div class="modal fade" id="modal-label" tabindex="-1">
        <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content border-0 shadow-lg" style="border-radius: 20px;">
                <div class="modal-body p-4 text-center">
                    <h6 class="fw-bold mb-3">Gerar Etiqueta QR</h6>
                    <div id="label-wrapper-modal" class="bg-white p-2 border rounded">
                        <div id="label-preview">
                            <div style="font-size: 9px; font-weight: 800; color: #6a0dad; border-bottom: 1.5px solid #6a0dad; width: 100%; padding-bottom: 3px;">KARMEM FARDAMENTOS</div>
                            <div id="label-name" style="font-size: 10px; font-weight: 700; margin-top: 6px; line-height: 1.1;">PRODUTO</div>
                            <div style="font-size: 9px; margin: 2px 0;">TAMANHO: <b id="label-size">M</b></div>
                            <div id="qrcode" style="margin: 6px 0; display: inline-block;"></div>
                            <div style="font-size: 7px; color: #777;">REF: <span id="label-id">000</span></div>
                            <div id="label-price" style="font-size: 14px; font-weight: 900; background: #6a0dad; color: white; width: 100%; padding: 4px 0;">R$ 0,00</div>
                        </div>
                    </div>
                    <div class="d-grid gap-2 mt-4"><button onclick="window.printCurrentLabel()" class="btn btn-brand py-2">Imprimir</button><button data-bs-dismiss="modal" class="btn btn-light border py-2">Fechar</button></div>
                </div>
            </div>
        </div>
    </div>

    <div id="label-print-area"></div>
    <div id="thermal-receipt"></div>

    <script>
        const API_URL = 'http://localhost:3000/api';
        let db = { products: [], clients: [], sales: [], quotes: [] };
        let cart = [];
        let isOnline = false;
        let chartDaily = null;
        window.currentEditQuoteId = null;

        async function api(path, method = 'GET', body = null) {
            try {
                const options = { method, headers: { 'Content-Type': 'application/json' }, body: body ? JSON.stringify(body) : null };
                const res = await fetch(`${API_URL}${path}`, options);
                const data = await res.json();
                updateStatus(true);
                return data;
            } catch (e) { updateStatus(false); return null; }
        }

        function updateStatus(online) {
            isOnline = online;
            const b = document.getElementById('connection-status');
            b.innerText = online ? 'SISTEMA ONLINE' : 'OFFLINE';
            b.className = `status-badge ${online ? 'bg-success text-white shadow-sm' : 'bg-danger text-white animate-pulse'}`;
        }

        async function loadAllData() {
            const [p, c, q, s] = await Promise.all([api('/products'), api('/clients'), api('/quotes'), api('/sales/client/all')]);
            db.products = p || []; db.clients = c || []; db.quotes = q || []; db.sales = s || [];
            window.render();
        }

        window.handleSearchInput = (e) => {
            const searchInput = e.target;
            const search = searchInput.value.toLowerCase().trim();
            if (!search) { window.render(); return; }
            const exactMatch = db.products.find(p => p.id.toString() === search);
            if (exactMatch) {
                if (exactMatch.stock > 0) {
                    window.addToCart(exactMatch.id);
                    searchInput.value = "";
                    searchInput.focus();
                } else {
                    searchInput.value = "";
                }
            }
            window.render();
        };

        window.render = () => {
            const search = document.getElementById('search-pos').value.toLowerCase().trim();
            const posGrid = document.getElementById('pos-grid');
            if (!search) {
                posGrid.innerHTML = `<div class="col-12 py-5 text-center text-muted opacity-40"><i class="bi bi-qr-code-scan fs-1"></i><h6 class="fw-bold mt-2">Aguardando Leitura</h6></div>`;
            } else {
                const filtered = db.products.filter(p => p.name.toLowerCase().includes(search) || p.id.toString() === search);
                posGrid.innerHTML = filtered.map(p => `<div class="col-md-4 col-6"><div class="card card-product border-light shadow-sm h-100 ${p.stock <= 0 ? 'opacity-50 grayscale' : ''}" onclick="${p.stock > 0 ? `window.addToCart(${p.id})` : ''}"><div class="card-body p-3 text-center"><span class="badge bg-primary bg-opacity-10 text-primary mb-2">Tam. ${p.size}</span><h6 class="fw-bold text-slate-800 m-0 text-truncate">${p.name}</h6><div class="mt-2 fw-bold text-primary">R$ ${parseFloat(p.price).toFixed(2)}</div><small class="text-muted">ID: ${p.id}</small></div></div></div>`).join('') || '<div class="col-12 text-center text-muted">N√£o localizado.</div>';
            }
            
            let totalVal = 0, lowStock = 0, totalItems = 0;
            document.getElementById('inventory-table').innerHTML = db.products.map(p => {
                const s = parseInt(p.stock); totalItems += s; totalVal += (s * parseFloat(p.price)); if (s <= 5) lowStock++;
                return `<tr><td><b>${p.name}</b> (${p.size})</td><td>R$ ${parseFloat(p.price).toFixed(2)}</td><td>${s}</td><td class="text-end"><div class="btn-group border rounded shadow-sm"><button onclick="window.generateLabel(${p.id})" class="btn btn-sm btn-light text-primary"><i class="bi bi-qr-code"></i></button><button onclick="window.editProd(${p.id})" class="btn btn-sm btn-light border-start"><i class="bi bi-pencil"></i></button><button onclick="window.deleteDoc('products', ${p.id})" class="btn btn-sm btn-light text-danger border-start"><i class="bi bi-trash"></i></button></div></td></tr>`
            }).join('');

            document.getElementById('stock-stat-count').innerText = db.products.length;
            document.getElementById('stock-stat-items').innerText = totalItems;
            document.getElementById('stock-stat-value').innerText = `R$ ${totalVal.toFixed(2)}`;
            document.getElementById('stock-stat-low').innerText = lowStock;
            
            document.getElementById('clients-table').innerHTML = db.clients.map(c => `<tr><td><b>${c.name}</b><br><small class="text-muted">${c.email || ''}</small></td><td>${c.phone || '-'}<br><small class="text-muted">${c.address || ''}</small></td><td class="text-end"><button onclick="window.editCli(${c.id})" class="btn btn-sm btn-light border shadow-sm px-3"><i class="bi bi-pencil-square"></i> Ficha</button></td></tr>`).join('');
            
            document.getElementById('all-quotes-table').innerHTML = db.quotes.map(q => {
                const s = q.status === 'Aprovado' ? 'bg-success' : (q.status === 'Recusado' ? 'bg-danger' : 'bg-secondary');
                return `<tr><td><b>ORC-${q.id.split('-').pop()}</b></td><td><small>${q.date}</small></td><td>${q.client_name || 'Particular'}</td><td><b class="text-primary">R$ ${parseFloat(q.total).toFixed(2)}</b></td><td class="text-center"><span class="badge ${s} bg-opacity-10 ${s.replace('bg-','text-')}">${q.status}</span></td><td class="text-center"><div class="btn-group border rounded shadow-sm"><button onclick="window.printFormalPDF('${q.id}')" class="btn btn-sm btn-light text-primary px-3"><i class="bi bi-file-earmark-pdf-fill"></i></button><button onclick="window.shareQuote('${q.id}')" class="btn btn-sm btn-light text-success px-3"><i class="bi bi-whatsapp"></i></button></div></td><td class="text-end"><div class="btn-group border rounded shadow-sm"><button onclick="window.updateQuoteStatus('${q.id}', 'Aprovado')" class="btn btn-sm btn-light text-success px-2"><i class="bi bi-check-circle-fill"></i></button><button onclick="window.updateQuoteStatus('${q.id}', 'Recusado')" class="btn btn-sm btn-light text-warning px-2"><i class="bi bi-x-circle"></i></button><button onclick="window.loadQuoteForEdit('${q.id}')" class="btn btn-sm btn-light text-primary px-2"><i class="bi bi-pencil-square"></i></button><button onclick="window.deleteDoc('quotes', '${q.id}')" class="btn btn-sm btn-light text-danger px-2"><i class="bi bi-trash3"></i></button></div></td></tr>`}).join('');

            const opts = '<option value="">Filtro Cliente...</option>' + db.clients.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            document.getElementById('client-select-pos').innerHTML = opts;
            document.getElementById('report-select-client').innerHTML = opts + '<option value="null">Vendas sem V√≠nculo</option>';
        }

        // --- DASHBOARD DE RELAT√ìRIO ---
        window.initDashboard = async () => {
            const filterMonth = document.getElementById('report-month-filter').value || new Date().toISOString().slice(0, 7);
            document.getElementById('report-month-filter').value = filterMonth;
            const s = await api('/sales/client/all'); db.sales = s || [];
            const monthly = db.sales.filter(s => (s.sale_date || s.date).startsWith(filterMonth));
            const grouped = {}; let totalMonth = 0; let totalToday = 0; const todayStr = new Date().toISOString().split('T')[0];
            
            monthly.forEach(s => {
                const day = (s.sale_date || s.date).split('T')[0];
                const val = parseFloat(s.total_amount || s.total || 0);
                totalMonth += val; if (day === todayStr) totalToday += val;
                if (!grouped[day]) grouped[day] = { total: 0, sales: [] };
                grouped[day].total += val; grouped[day].sales.push(s);
            });
            
            document.getElementById('stat-today').innerText = `R$ ${totalToday.toFixed(2)}`;
            document.getElementById('stat-month').innerText = `R$ ${totalMonth.toFixed(2)}`;
            document.getElementById('stat-count').innerText = monthly.length;
            document.getElementById('stat-ticket').innerText = `R$ ${(monthly.length > 0 ? totalMonth/monthly.length : 0).toFixed(2)}`;

            const days = Object.keys(grouped).sort();
            if (chartDaily) chartDaily.destroy();
            chartDaily = new Chart(document.getElementById('chart-daily').getContext('2d'), {
                type: 'line', data: { labels: days.map(d => d.split('-').reverse().join('/')), datasets: [{ label: 'Vendas', data: days.map(d => grouped[d].total), borderColor: '#6a0dad', backgroundColor: 'rgba(106, 13, 173, 0.05)', fill: true, tension: 0.4 }] },
                options: { plugins: { legend: { display: false } } }
            });

            document.getElementById('daily-details-accordion').innerHTML = days.reverse().map((day) => {
                const dayId = day.replace(/-/g, '');
                return `<div class="accordion-item bg-transparent"><h2 class="accordion-header"><button class="accordion-button collapsed py-2 px-3 bg-white shadow-none" type="button" data-bs-toggle="collapse" data-bs-target="#collapse-${dayId}"><div class="w-100 d-flex justify-content-between pe-3 align-items-center"><span class="small"><b>${day.split('-').reverse().join('/')}</b></span><span class="badge bg-primary bg-opacity-10 text-primary fw-bold border">R$ ${grouped[day].total.toFixed(2)}</span></div></button></h2><div id="collapse-${dayId}" class="accordion-collapse collapse" data-bs-parent="#daily-details-accordion"><div class="accordion-body p-0 border-top"><table class="table table-sm table-hover m-0" style="font-size: 0.8rem;"><tbody>${grouped[day].sales.map(s => `<tr><td class="ps-3 py-2 text-muted">#${s.id}</td><td>${s.client_name || 'Particular'}</td><td class="text-end fw-bold">R$ ${parseFloat(s.total_amount).toFixed(2)}</td><td class="text-end pe-3"><div class="btn-group"><button onclick="window.reprintSale('${s.id}')" class="btn btn-sm btn-link text-primary p-1" title="Imprimir Cupom"><i class="bi bi-printer"></i></button><button onclick="window.cancelSale('${s.id}')" class="btn btn-sm btn-link text-danger p-1" title="Estornar Venda"><i class="bi bi-arrow-counterclockwise"></i></button></div></td></tr>`).join('')}</tbody></table></div></div></div>`}).join('') || '<p class="text-center py-4 text-muted small">Sem vendas registadas.</p>';
        };

        window.renderClientHistory = async (cid) => {
            const container = document.getElementById('report-content');
            container.innerHTML = '<div class="text-center py-5"><div class="spinner-border text-primary"></div></div>';
            const sales = await api(`/sales/client/${cid}`);
            container.innerHTML = `<table class="table table-sm align-middle mb-0" style="font-size: 0.85rem;"><thead class="bg-slate-50 text-muted small fw-bold"><tr><th class="ps-2">Data</th><th class="text-end">Valor</th><th class="text-end pe-2">A√ß√µes</th></tr></thead><tbody>${sales.map(s => `<tr><td class="ps-2"><small>${new Date(s.sale_date || s.date).toLocaleDateString('pt-BR')}</small></td><td class="text-end fw-bold text-slate-700">R$ ${parseFloat(s.total_amount || s.total).toFixed(2)}</td><td class="text-end"><button onclick="window.reprintSale('${s.id}')" class="btn btn-sm text-primary p-0 me-1" title="Imprimir"><i class="bi bi-printer"></i></button><button onclick="window.cancelSale('${s.id}')" class="btn btn-sm text-danger p-0" title="Estornar"><i class="bi bi-arrow-counterclockwise"></i></button></td></tr>`).join('') || '<tr><td colspan="3" class="text-center py-4 text-muted">Sem registros.</td></tr>'}</tbody></table>`;
        }

        window.cancelSale = async (saleId) => {
            const reason = prompt(`ESTORNO DE VENDA #${saleId}\nInforme o motivo do cancelamento:`);
            if (reason === null || reason.trim() === "") return alert("Justificativa obrigat√≥ria!");
            if (confirm(`Confirmar estorno da venda #${saleId}?\nOs artigos voltar√£o ao stock.`)) {
                const res = await api(`/sales/${saleId}`, 'DELETE', { reason: reason });
                if (res) { alert("Estorno processado!"); await loadAllData(); window.initDashboard(); if (document.getElementById('report-select-client').value) window.renderClientHistory(document.getElementById('report-select-client').value); }
            }
        };

        window.reprintSale = (saleId) => {
            const sale = db.sales.find(s => String(s.id) === String(saleId));
            if (sale) { 
                document.getElementById('label-print-area').innerHTML = '';
                window.printThermalReceipt({ id: sale.id, client_id: sale.client_id, subtotal: sale.subtotal, discount: sale.discount, total: sale.total_amount || sale.total, sale_date: sale.sale_date, items: sale.items || [] }); 
            }
        };

        // --- MOTOR DE PDF DE LUXO / BOUTIQUE (ELEGANTE E REFINADO) ---
        window.printFormalPDF = async (id) => {
            const q = db.quotes.find(x => x.id == id); if (!q) return;
            const client = db.clients.find(c => String(c.id) === String(q.client_id));
            const total = parseFloat(q.total || q.total_amount || 0).toFixed(2);
            
            const pdfHtml = `
                <div style="width: 100%; padding: 60px 50px; background: #fff; font-family: 'Inter', sans-serif; color: #1e293b;">
                    <div style="max-width: 800px; margin: 0 auto; position: relative; border: 1px solid #f1f5f9; padding: 50px; min-height: 1000px; display: flex; flex-direction: column; background: #ffffff;">
                        <div style="position: absolute; left: 0; top: 0; width: 4px; height: 100%; background: #6a0dad; opacity: 0.7;"></div>
                        <div style="text-align: center; margin-bottom: 70px;">
                            <h1 style="font-family: 'Playfair Display', serif; font-size: 32px; color: #6a0dad; margin: 0; text-transform: uppercase; font-weight: 800; letter-spacing: 3px; line-height: 1;">Karmem Fardamentos</h1>
                            <p style="font-size: 11px; text-transform: uppercase; letter-spacing: 6px; color: #94a3b8; margin-top: 15px; font-weight: 600;">Alta Confec√ß√£o & Atelier de Luxo</p>
                        </div>
                        <div style="display: flex; justify-content: space-between; margin-bottom: 60px; border-bottom: 1px solid #f8fafc; padding-bottom: 35px;">
                            <div style="width: 45%;">
                                <span style="font-size: 9px; font-weight: 800; color: #6a0dad; display: block; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1.5px;">Cliente:</span>
                                <b style="font-size: 16px; font-family: 'Playfair Display', serif; color: #0f172a; display: block; margin-bottom: 5px;">${(client?.name || q.client_name || 'Particular').toUpperCase()}</b>
                                <div style="font-size: 12px; color: #64748b; line-height: 1.6;">WhatsApp: ${client?.phone || 'N/A'}<br>Endere√ßo: ${client?.address || 'N/A'}</div>
                            </div>
                            <div style="width: 45%; text-align: right;">
                                <span style="font-size: 9px; font-weight: 800; color: #6a0dad; display: block; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1.5px;">Or√ßamento:</span>
                                <b style="font-size: 14px; color: #0f172a; display: block; margin-bottom: 5px;">REF: ${q.id.split('-').pop()}</b>
                                <div style="font-size: 12px; color: #64748b; line-height: 1.6;">Emiss√£o: ${q.date.split(',')[0]}<br>Validade: 7 dias √∫teis</div>
                            </div>
                        </div>
                        <div style="flex-grow: 1;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead><tr style="border-bottom: 1.5px solid #0f172a;"><th style="padding: 15px 5px; font-size: 10px; font-weight: 800; text-transform: uppercase; color: #64748b; text-align: left; letter-spacing: 1.5px;">Artigo / Descri√ß√£o</th><th style="padding: 15px 5px; font-size: 10px; font-weight: 800; text-transform: uppercase; color: #64748b; text-align: center; width: 60px;">Qtd</th><th style="padding: 15px 5px; font-size: 10px; font-weight: 800; text-transform: uppercase; color: #64748b; text-align: right; width: 130px;">Subtotal</th></tr></thead>
                                <tbody>${(q.items || []).map(i => `<tr style="border-bottom: 1px solid #f8fafc;"><td style="padding: 25px 5px; font-size: 13px; color: #0f172a;"><b>${(i.product_name || i.name).toUpperCase()}</b><br><span style="font-size: 10px; color: #94a3b8; font-weight: 500;">Tamanho: ${i.size || 'N/A'}</span></td><td style="padding: 25px 5px; font-size: 13px; text-align: center; color: #475569;">${i.quantity || i.qty}</td><td style="padding: 25px 5px; font-size: 13px; text-align: right; font-weight: 700; color: #0f172a;">R$ ${((i.quantity || i.qty) * (i.price_unit || i.price)).toFixed(2)}</td></tr>`).join('')}</tbody>
                            </table>
                        </div>
                        <div style="display: flex; justify-content: flex-end; margin-top: 50px;"><div style="width: 300px; padding: 30px; background: #fdfcff; border: 1px solid #e2e8f0; border-radius: 20px;"><div style="display: flex; justify-content: space-between; margin-bottom: 15px; font-size: 12px; color: #94a3b8; font-weight: 600;"><span style="letter-spacing: 1px;">SOMA BRUTA</span><span>R$ ${parseFloat(q.subtotal || total).toFixed(2)}</span></div><div style="display: flex; justify-content: space-between; border-top: 2px solid #6a0dad; padding-top: 25px; color: #6a0dad;"><b style="font-size: 13px; align-self: center; font-weight: 900; letter-spacing: 1px;">TOTAL</b><b style="font-size: 28px; font-family: 'Playfair Display', serif; font-weight: 900;">R$ ${total}</b></div></div></div>
                        <div style="margin-top: 100px; display: flex; justify-content: space-between; padding: 0 40px;"><div style="width: 240px; text-align: center; border-top: 1px solid #0f172a; padding-top: 12px; font-size: 10px; color: #0f172a; text-transform: uppercase; font-weight: 700; letter-spacing: 1.5px;">Atelier Karmem</div><div style="width: 240px; text-align: center; border-top: 1px solid #0f172a; padding-top: 12px; font-size: 10px; color: #0f172a; text-transform: uppercase; font-weight: 700; letter-spacing: 1.5px;">Aceite do Cliente</div></div>
                        <div style="margin-top: 50px; text-align: center; font-size: 10px; color: #cbd5e1; font-style: italic; letter-spacing: 0.5px;">Eleg√¢ncia e Qualidade em cada detalhe. Karmem Fardamentos agradece.</div>
                    </div>
                </div>`;
            await html2pdf().from(pdfHtml).set({ margin: 0, filename: `Karmem_ORC${q.id.split('-').pop()}.pdf`, html2canvas: { scale: 3, useCORS: true }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } }).save();
        };

        // --- MOTOR DE CUP√ÉO T√âRMICO (FONTE AJUSTADA) ---
        window.printThermalReceipt = (data) => {
            const container = document.getElementById('thermal-receipt');
            const now = new Date(data.sale_date || data.date || Date.now());
            const client = db.clients.find(c => String(c.id) === String(data.client_id)) || { name: 'CONSUMIDOR FINAL' };
            
            document.getElementById('label-print-area').innerHTML = '';
            
            let html = `<div style="text-align:center; margin-top:0; padding-top:0;"><b style="font-size:15px; display:block;">KARMEM FARDAMENTOS</b><span style="font-size:10px;">ALTA CONFECCAO & ATELIER</span><br><span style="font-size:9px;">PERNAMBUCO - BRASIL</span><br>----------------------------<br><b style="font-size:11px;">CUPOM NAO FISCAL</b></div><div class="receipt-sep"></div>REF: ${data.id}<br>DATA: ${now.toLocaleDateString('pt-BR')} ${now.toLocaleTimeString('pt-BR')}<br>CLI: ${client.name.toUpperCase().substring(0, 20)}<br><div class="receipt-sep"></div><b style="font-size:11px;">DESCRI√á√ÉO     QTD    TOTAL</b><br>`;
            if(data.items && data.items.length > 0) {
                data.items.forEach(i => {
                    const name = (i.product_name || i.name).toUpperCase().substring(0, 12).padEnd(12, '.');
                    const qty = (i.qty || i.quantity).toString().padStart(3, ' ');
                    const price = parseFloat(i.price || i.price_unit);
                    const sub = ( (i.qty || i.quantity) * price ).toFixed(2).padStart(8, ' ');
                    html += `<div style="font-size:12px;" class="receipt-row"><span>${name}</span><span>${qty}</span><span>${sub}</span></div>`;
                });
            } else { html += `<div style="text-align:center;">DETALHES REGISTADOS</div>`; }
            html += `<div class="receipt-sep"></div><div class="receipt-row"><span>SUBTOTAL:</span><span>R$ ${parseFloat(data.subtotal || data.total).toFixed(2)}</span></div><div style="font-size:13px; font-weight:900; margin-top: 3px;" class="receipt-row"><span>TOTAL:</span><span>R$ ${parseFloat(data.total).toFixed(2)}</span></div><div class="receipt-sep"></div><div style="text-align:center; margin-top:6px; font-weight:700; font-size:9px;">OBRIGADO PELA PREFER√äNCIA!<br>@fardamentoskarmem</div><br>.`;
            container.innerHTML = html;
            window.print();
        };

        window.shareQuote = (id) => {
            const q = db.quotes.find(x => x.id == id); if (!q) return;
            const client = db.clients.find(c => String(c.id) === String(q.client_id));
            let msg = `üåü *KARMEM FARDAMENTOS* üåü\nOl√° *${client?.name || 'Cliente'}*,\nSegue or√ßamento Ref: ORC-${q.id.split('-').pop()}\nüí∞ *TOTAL: R$ ${parseFloat(q.total).toFixed(2)}* üôè`;
            window.open(`https://wa.me/55${(client?.phone || '').replace(/\D/g,'')}?text=${encodeURIComponent(msg)}`, '_blank');
        };

        window.generateLabel = (id) => {
            const p = db.products.find(x => x.id == id); if (!p) return;
            document.getElementById('label-name').innerText = p.name.toUpperCase();
            document.getElementById('label-size').innerText = p.size;
            document.getElementById('label-id').innerText = p.id;
            document.getElementById('label-price').innerText = `R$ ${parseFloat(p.price).toFixed(2)}`;
            const qrContainer = document.getElementById('qrcode'); qrContainer.innerHTML = "";
            new QRCode(qrContainer, { text: p.id.toString(), width: 100, height: 100, colorDark : "#000000", colorLight : "#ffffff", correctLevel : QRCode.CorrectLevel.H });
            new bootstrap.Modal(document.getElementById('modal-label')).show();
        };

        window.printCurrentLabel = () => {
            document.getElementById('thermal-receipt').innerHTML = '';
            const labelContent = document.getElementById('label-wrapper-modal').innerHTML;
            const printArea = document.getElementById('label-print-area');
            printArea.innerHTML = labelContent;
            printArea.style.display = "block";
            window.print();
            printArea.style.display = "none";
        };

        window.updateQuoteStatus = async (id, newStatus) => { await api(`/quotes/${id}/status`, 'POST', { status: newStatus }); if (newStatus === 'Aprovado') await window.printFormalPDF(id); loadAllData(); };
        window.addToCart = (id) => { const p = db.products.find(x => x.id == id); if (!p) return; const inCart = cart.find(x => x.id == id); if (inCart) inCart.qty++; else cart.push({ ...p, qty: 1, price: parseFloat(p.price) }); window.updateCartUI(); document.getElementById('search-pos').value = ''; window.render(); };
        window.updateCartUI = () => {
            let s = 0; document.getElementById('cart-items').innerHTML = cart.map((item, i) => { const sub = item.price * item.qty; s += sub; return `<div class="cart-item"><div class="d-flex justify-content-between"><b>${item.name}</b><button onclick="cart.splice(${i},1);window.updateCartUI()" class="btn btn-sm text-danger p-0 border-0"><i class="bi bi-x-circle-fill"></i></button></div><div class="d-flex justify-content-between small text-muted"><span>Tam: ${item.size} x${item.qty}</span><span class="fw-bold text-primary">R$ ${sub.toFixed(2)}</span></div></div>`; }).join('') || '<div class="text-center py-5 text-slate-300 small">Checkout Vazio</div>';
            document.getElementById('cart-total').innerText = `R$ ${s.toFixed(2)}`; document.getElementById('btn-finish').disabled = document.getElementById('btn-quote').disabled = cart.length === 0;
        }

        window.handleTransaction = async (type) => {
            const cid = document.getElementById('client-select-pos').value;
            const subtotal = cart.reduce((s, i) => s + (i.price * i.qty), 0);
            const data = { id: (type === 'quote' && window.currentEditQuoteId) ? window.currentEditQuoteId : (type==='sale'?'KF-':'ORC-') + Date.now().toString().slice(-5), client_id: cid || null, paymentMethod: document.getElementById('payment-method-pos').value, subtotal, discount: 0, total: subtotal, items: cart };
            const res = await api(type === 'sale' ? '/sales' : '/quotes', 'POST', data); 
            if (res) { 
                if (type === 'sale' && confirm("Conclu√≠do! Imprimir Cupom?")) {
                    window.printThermalReceipt(data); 
                }
                window.currentEditQuoteId = null; document.getElementById('edit-mode-badge').classList.add('d-none'); cart = []; window.updateCartUI(); loadAllData(); 
            }
        }

        window.editProd = (id) => { const p = db.products.find(x => x.id == id); document.getElementById('p-id').value = p.id; document.getElementById('p-name').value = p.name; document.getElementById('p-size').value = p.size; document.getElementById('p-price').value = p.price; document.getElementById('p-stock').value = p.stock; document.getElementById('form-product').scrollIntoView({ behavior: 'smooth' }); };
        window.editCli = (id) => { const c = db.clients.find(x => x.id == id); document.getElementById('c-id').value = c.id; document.getElementById('c-name').value = c.name; document.getElementById('c-phone').value = c.phone; document.getElementById('c-email').value = c.email; document.getElementById('c-cpf').value = c.cpf; document.getElementById('c-address').value = c.address; document.getElementById('m-bust').value = c.m_bust; document.getElementById('m-waist').value = c.m_waist; document.getElementById('m-hips').value = c.m_hips; document.getElementById('m-shoulder').value = c.m_shoulder; document.getElementById('m-sleeve').value = c.m_sleeve; document.getElementById('m-length-up').value = c.m_length_up; document.getElementById('m-length-down').value = c.m_length_down; document.getElementById('c-notes').value = c.notes; document.getElementById('form-client').scrollIntoView({ behavior: 'smooth' }); };
        window.deleteDoc = async (col, id) => { if (confirm("Deseja mesmo eliminar?")) { await api(`/${col}/${id}`, 'DELETE'); loadAllData(); } };
        window.loadQuoteForEdit = (id) => { const q = db.quotes.find(x => x.id == id); if (!q) return; window.currentEditQuoteId = q.id; document.getElementById('edit-mode-badge').classList.remove('d-none'); cart = q.items.map(i => ({ id: i.product_id, name: i.product_name, qty: i.quantity, price: parseFloat(i.price_unit) })); document.getElementById('client-select-pos').value = q.client_id || ""; window.updateCartUI(); bootstrap.Tab.getOrCreateInstance(document.querySelector('a[href="#tab-vendas"]')).show(); };
        window.clearCart = () => { cart = []; window.currentEditQuoteId = null; document.getElementById('edit-mode-badge').classList.add('d-none'); window.updateCartUI(); };
        
        document.getElementById('form-product').onsubmit = async (e) => { e.preventDefault(); const pId = document.getElementById('p-id').value; const body = { id: pId, name: document.getElementById('p-name').value, size: document.getElementById('p-size').value, price: parseFloat(document.getElementById('p-price').value), stock: parseInt(document.getElementById('p-stock').value) }; const res = await api('/products', 'POST', body); if (res) { e.target.reset(); document.getElementById('p-id').value = ''; await loadAllData(); if (!pId) window.generateLabel(res.id); } };
        document.getElementById('form-client').onsubmit = async (e) => { e.preventDefault(); const body = { id: document.getElementById('c-id').value, name: document.getElementById('c-name').value, phone: document.getElementById('c-phone').value, email: document.getElementById('c-email').value, cpf: document.getElementById('c-cpf').value, address: document.getElementById('c-address').value, m_bust: document.getElementById('m-bust').value, m_waist: document.getElementById('m-waist').value, m_hips: document.getElementById('m-hips').value, m_shoulder: document.getElementById('m-shoulder').value, m_sleeve: document.getElementById('m-sleeve').value, m_length_up: document.getElementById('m-length-up').value, m_length_down: document.getElementById('m-length-down').value, notes: document.getElementById('c-notes').value }; const res = await api('/clients', 'POST', body); if (res) { e.target.reset(); document.getElementById('c-id').value=''; loadAllData(); alert("Ficha t√©cnica guardada!"); } };

        window.onload = loadAllData;
    </script>
</body>
</html>